<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presales Discovery & ROI Tool</title>
    <!-- Document Icon (Favicon) -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBwdiI+PHBhdGggZD0iTTE1IDJINmEyIDIgMCAwIDAtMiAydjE2YTIgMiAwIDAgMCAyIDJoMTJhMiAyIDAgMCAwIDItMlY3WiIvPjxwYXRoIGQ9Ik0xNCAydjRhMiAyIDAgMCAyIDJoNCIvPjxwYXRoGkQ9Ik0xMCA5SDh2NHoiLz48cGF0aCBkPSJNMTYgMTNINjZlLTgiLz48cGF0aCBkPSJNMTYgMTdoNCAvPjwvc3ZnPg==" type="image/svg+xml">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .bg-ms-blue { background-color: #0078D4; }
        .hover\:bg-ms-blue-dark:hover { background-color: #005B9C; }
        .text-ms-blue { color: #0078D4; }
        .border-ms-blue-light { border-color: #A0CBE8; }
        .ring-ms-blue { --tw-ring-color: #0078D4; }
        .form-radio:checked { background-color: #0078D4; border-color: #0078D4; }
        .form-radio:checked:focus { border-color: #A0CBE8; box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.25); }
        select, input[type="number"], textarea { transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        select:focus, input[type="number"]:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.25); border-color: #0078D4; }
        button { transition: all 0.3s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border-radius: 0.5rem; }
        button:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transform: translateY(-2px); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); max-width: 400px; width: 90%; text-align: center; }
        #app-content .flex button { border-radius: 0.5rem; }
        #app-content .flex button + button { margin-left: -1px; }
        #app-content .flex button:first-child { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        #app-content .flex button:last-child { border-top-left-radius: 0; border-bottom-left-radius: 0; }
        #app-content .flex button:not(:first-child):not(:last-child) { border-radius: 0; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col items-center p-4 font-sans text-gray-800">
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-ms-blue mb-6">
            Presales Discovery & ROI Tool
        </h1>

        <!-- Stream & Module Selection -->
        <div class="mb-8 p-4 bg-blue-100 rounded-lg shadow-md flex flex-col md:flex-row items-center justify-center gap-4">
             <div class="w-full md:w-1/2 flex flex-col items-center">
                 <label for="stream-select" class="text-lg font-semibold text-blue-800 mb-2">Select Business Stream:</label>
                 <div class="relative w-full">
                     <select id="stream-select" class="block w-full px-4 py-2 pr-8 rounded-md border border-blue-300 bg-white text-gray-900 focus:outline-none focus:ring-2 ring-ms-blue focus:border-transparent appearance-none">
                         <!-- Options populated by JS -->
                     </select>
                     <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-blue-700">
                         <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                     </div>
                 </div>
             </div>
             <div class="w-full md:w-1/2 flex flex-col items-center">
                <label for="module-select" class="text-lg font-semibold text-blue-800 mb-2">Select Module:</label>
                <div class="relative w-full">
                    <select id="module-select" class="block w-full px-4 py-2 pr-8 rounded-md border border-blue-300 bg-white text-gray-900 focus:outline-none focus:ring-2 ring-ms-blue focus:border-transparent appearance-none">
                        <option value="">-- Choose Stream First --</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-blue-700">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                </div>
            </div>
        </div>


        <div id="app-content">
            <!-- Content will be dynamically loaded here by JavaScript -->
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-col md:flex-row justify-center items-center gap-4">
            <button id="clear-form-button" class="flex items-center bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                Clear Module Data
            </button>
            <div class="flex flex-col items-center p-4 bg-blue-50 rounded-lg shadow-sm">
                <p class="font-semibold text-blue-800 mb-2">Export As:</p>
                <div class="flex flex-wrap justify-center gap-4">
                    <label class="inline-flex items-center"><input type="radio" name="export-format" value="md" checked class="form-radio text-ms-blue border-gray-300"><span class="ml-2 text-gray-700">Markdown</span></label>
                    <label class="inline-flex items-center"><input type="radio" name="export-format" value="txt" class="form-radio text-ms-blue border-gray-300"><span class="ml-2 text-gray-700">Plain Text</span></label>
                    <label class="inline-flex items-center"><input type="radio" name="export-format" value="html" class="form-radio text-ms-blue border-gray-300"><span class="ml-2 text-gray-700">HTML</span></label>
                    <label class="inline-flex items-center"><input type="radio" name="export-format" value="ai-prompt" class="form-radio text-ms-blue border-gray-300"><span class="ml-2 text-gray-700">AI Prompt</span></label>
                </div>
                <button id="export-data-button" class="flex items-center bg-ms-blue hover:bg-ms-blue-dark text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 ring-ms-blue focus:ring-offset-2 mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    Export Data
                </button>
            </div>
        </div>

        <!-- Messages -->
         <div id="export-success-message" class="hidden mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-md flex items-center" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg><span>Data exported successfully!</span></div>
         <div id="copy-success-message" class="hidden mt-4 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg shadow-md flex items-center" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M9 5H2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5l-7-5Z"/><path d="M15 2v4a2 2 0 0 0 2 2h4"/><path d="M12 18v-6"/><path d="M9 15h6"/></svg><span>Values copied to ROI Calculator!</span></div>
         <div id="validation-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-md mb-4 flex items-center justify-between" role="alert"><div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg><span>Please ensure all required fields are filled, especially for ROI calculation.</span></div><button id="close-validation-error" class="ml-4 text-red-700 hover:text-red-900"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg></button></div>
    </div>

    <!-- Modal -->
    <div id="confirmation-modal" class="modal hidden"><div class="modal-content"><p class="text-lg font-semibold mb-4">Are you sure you want to clear all data for this module?</p><div class="flex justify-center gap-4"><button id="confirm-clear-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg">OK</button><button id="cancel-clear-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-lg">Cancel</button></div></div></div>
    <footer class="mt-8 text-gray-500 text-sm">(c) Brad Whatman 2025</footer>

    <script>
        const FTE_HOURS_PER_YEAR = 2080;

        // --- Data Structure for all Modules, organized by Business Stream ---
        const appModules = {
            'Finance Automation': {
                'Accounts Receivable': {
                    questions: [
                        { id: 'ar1', text: 'How many invoices do you issue per month?', type: 'number' },
                        { id: 'ar2', text: 'What is your average invoice value? ($)', type: 'number' },
                        { id: 'ar3', text: 'What is your current DSO (Days Sales Outstanding)?', type: 'number' },
                        { id: 'ar5', text: 'What challenges do you face with cash application?', type: 'textarea' },
                        { id: 'ar8', text: 'How many staff are involved in AR processes (FTEs)?', type: 'number' },
                        { id: 'ar18', text: 'What is the biggest pain point in your current AR process?', type: 'textarea' },
                    ],
                    roiQuestions: [
                        { id: 'roi_ar1', text: 'Average cost to manually process one invoice ($)', type: 'number' },
                        { id: 'roi_ar2', text: 'Number of full-time employees (FTEs) dedicated to AR', type: 'number' },
                        { id: 'roi_ar3', text: 'Average annual salary + benefits for AR staff ($)', type: 'number' },
                        { id: 'roi_ar10', text: 'Annual volume of invoices issued', type: 'number' },
                        { id: 'roi_ar9', text: 'Average annual bad debt write-offs ($)', type: 'number' },
                        { id: 'roi_ar8', text: 'Cost of capital (annual interest rate for receivables, %)', type: 'number' },
                    ],
                    demoRoiData: { roi_ar1: 3.50, roi_ar2: 5, roi_ar3: 75000, roi_ar10: 120000, roi_ar9: 50000, roi_ar8: 5 },
                    roiCalculationFormulas: [
                        { name: 'Manual Processing Savings', formula: (i,s) => (i.annualInvoices * 0.7) * i.manualCost, inputs: { annualInvoices: 'roi_ar10', manualCost: 'roi_ar1' }, description: (i,s) => `(70% of ${i.annualInvoices} invoices * $${i.manualCost?.toFixed(2)})` },
                        { name: 'Bad Debt Reduction', formula: (i,s) => i.badDebt * 0.15, inputs: { badDebt: 'roi_ar9' }, description: (i,s) => `(15% of $${i.badDebt?.toFixed(2)})` },
                        { name: 'DSO Cash Flow Savings', formula: (i,s) => (((s.discoveryAnswers.ar1 * 12 * s.discoveryAnswers.ar2) / 365) * 10 * (i.costOfCapital/100)), inputs: { costOfCapital: 'roi_ar8' }, description: (i,s) => `(10 days DSO reduction)` }
                    ]
                },
                'Order Management': {
                     questions: [ { id: 'om1', text: 'How many sales orders do you process per month?', type: 'number' }, { id: 'om8', text: 'How many staff in Order Management (FTEs)?', type: 'number' } ],
                     roiQuestions: [ { id: 'roi_om1', text: 'Avg cost per manual sales order ($)', type: 'number' }, { id: 'roi_om8', text: 'Annual sales orders', type: 'number' }, { id: 'roi_om2', text: 'OM FTEs', type: 'number' } ],
                     demoRoiData: { roi_om1: 4.00, roi_om8: 72000, roi_om2: 4 },
                     roiCalculationFormulas: [ { name: 'Manual Processing Savings', formula: (i,s) => (i.annualOrders * 0.65) * i.manualCost, inputs: { annualOrders: 'roi_om8', manualCost: 'roi_om1' }, description: (i,s) => `(65% of ${i.annualOrders} orders * $${i.manualCost?.toFixed(2)})` } ]
                }
                // ... Other finance modules would be nested here
            },
            'Business Automation': {
                'Document Management': {
                    questions: [
                        { id: 'dm1', text: 'How many knowledge workers are in the company?', type: 'number' },
                        { id: 'dm2', text: 'On average, how many hours per week does an employee spend searching for documents or information?', type: 'number' },
                        { id: 'dm3', text: 'What is the primary challenge with your current document storage (e.g., folder chaos, version control, security)?', type: 'textarea' },
                        { id: 'dm4', text: 'Do you have compliance or audit requirements for your documents? If so, describe them.', type: 'textarea' },
                        { id: 'dm5', text: 'Describe a recent situation where finding the correct version of a document was critical and difficult.', type: 'textarea' }
                    ],
                    roiQuestions: [
                        { id: 'roi_dm1', text: 'Number of knowledge workers', type: 'number' },
                        { id: 'roi_dm2', text: 'Average annual fully-loaded salary for a knowledge worker ($)', type: 'number' },
                        { id: 'roi_dm3', text: 'Average hours per week spent searching for documents', type: 'number' },
                        { id: 'roi_dm4', text: 'Annual cost of external storage (physical or digital) ($)', type: 'number' },
                    ],
                    demoRoiData: { roi_dm1: 100, roi_dm2: 85000, roi_dm3: 5, roi_dm4: 10000 },
                    roiCalculationFormulas: [
                        {
                            name: 'Productivity Gain (Reduced Search Time)',
                            formula: (i, s) => (i.workers * i.hoursPerWeek * 52) * (i.avgSalary / FTE_HOURS_PER_YEAR) * 0.80,
                            inputs: { workers: 'roi_dm1', avgSalary: 'roi_dm2', hoursPerWeek: 'roi_dm3' },
                            description: (i, s) => `(80% of time saved for ${i.workers} workers)`
                        },
                        {
                            name: 'Storage Cost Reduction',
                            formula: (i, s) => i.storageCost * 0.50,
                            inputs: { storageCost: 'roi_dm4' },
                            description: (i, s) => `(50% reduction in storage costs)`
                        }
                    ]
                },
                'Workflow Management': {
                    questions: [
                        { id: 'wm1', text: 'How many repetitive, manual processes could be automated (e.g., approvals, notifications, data entry)?', type: 'number' },
                        { id: 'wm2', text: 'Describe one key process that is currently slow or error-prone due to manual steps.', type: 'textarea' },
                        { id: 'wm3', text: 'How do employees currently request services or approvals from other departments (e.g., IT, HR)?', type: 'textarea' },
                        { id: 'wm4', text: 'What is the business impact of delays in these manual processes?', type: 'textarea' },
                    ],
                    roiQuestions: [
                        { id: 'roi_wm1', text: 'Number of processes to automate', type: 'number' },
                        { id: 'roi_wm2', text: 'Average hours saved per automated process, per year', type: 'number' },
                        { id: 'roi_wm3', text: 'Average hourly cost of employees performing these tasks ($)', type: 'number' },
                        { id: 'roi_wm4', text: 'Estimated annual cost of errors from manual processes ($)', type: 'number' },
                    ],
                    demoRoiData: { roi_wm1: 20, roi_wm2: 100, roi_wm3: 40, roi_wm4: 15000 },
                    roiCalculationFormulas: [
                        {
                            name: 'Productivity Savings from Automation',
                            formula: (i, s) => i.processes * i.hoursSaved * i.hourlyCost,
                            inputs: { processes: 'roi_wm1', hoursSaved: 'roi_wm2', hourlyCost: 'roi_wm3' },
                            description: (i, s) => `(${i.processes} processes * ${i.hoursSaved} hrs/yr * $${i.hourlyCost}/hr)`
                        },
                        {
                            name: 'Error Reduction Savings',
                            formula: (i, s) => i.errorCost * 0.90,
                            inputs: { errorCost: 'roi_wm4' },
                            description: (i, s) => `(90% reduction in manual error costs)`
                        }
                    ]
                },
                'Process Mapping': {
                    questions: [
                        { id: 'pm1', text: 'How are your business processes currently documented (e.g., Word, Visio, tribal knowledge)?', type: 'textarea' },
                        { id: 'pm2', text: 'How long does it typically take to onboard a new employee for a key operational role?', type: 'number' },
                        { id: 'pm3', text: 'How do you currently identify bottlenecks or areas for improvement in your processes?', type: 'textarea' },
                        { id: 'pm4', text: 'Is there a consistent, agreed-upon "single source of truth" for how processes should be executed?', type: 'textarea' },
                    ],
                    roiQuestions: [
                        { id: 'roi_pm1', text: 'Number of new hires per year requiring process training', type: 'number' },
                        { id: 'roi_pm2', text: 'Average hours of training per new hire', type: 'number' },
                        { id: 'roi_pm3', text: 'Average hourly cost of a new hire and their trainer (combined) ($)', type: 'number' },
                        { id: 'roi_pm4', text: 'Total annual salary cost for all employees in operational roles ($)', type: 'number' },
                    ],
                    demoRoiData: { roi_pm1: 25, roi_pm2: 40, roi_pm3: 50, roi_pm4: 2000000 },
                    roiCalculationFormulas: [
                        {
                            name: 'Reduced Onboarding & Training Time',
                            formula: (i, s) => i.newHires * i.trainingHours * i.hourlyCost * 0.30,
                            inputs: { newHires: 'roi_pm1', trainingHours: 'roi_pm2', hourlyCost: 'roi_pm3' },
                            description: (i, s) => `(30% training time reduction for ${i.newHires} new hires)`
                        },
                        {
                            name: 'Operational Efficiency Gains',
                            formula: (i, s) => i.opSalaryCost * 0.03,
                            inputs: { opSalaryCost: 'roi_pm4' },
                            description: (i, s) => `(3% efficiency gain on $${i.opSalaryCost?.toFixed(2)} operational salaries)`
                        }
                    ]
                }
            }
        };

        const scorecardQuestions = [ { id: 'os1', text: "Customer's business needs align to our capability?" }, { id: 'os2', text: 'We have the access to all the key buying influences?' }, { id: 'os3', text: 'We have at least one Coach?' }, { id: 'os4', text: 'We can differentiate our solution from the competition and demonstrate value?' }, { id: 'os5', text: 'Customer has engaged us early in the process?' }, ];
        const scorecardAnswerOptions = ['Yes', 'No', 'Unknown'];
        const scorecardYesPoints = 20;

        // --- State Management ---
        let allModuleData = {};
        let selectedStream = '';
        let selectedModule = '';
        let currentView = 'scorecard';

        // --- DOM Elements ---
        const streamSelect = document.getElementById('stream-select');
        const moduleSelect = document.getElementById('module-select');
        const appContent = document.getElementById('app-content');
        const exportSuccessMessage = document.getElementById('export-success-message');
        const copySuccessMessage = document.getElementById('copy-success-message');
        const validationErrorMessage = document.getElementById('validation-error-message');
        const closeValidationErrorButton = document.getElementById('close-validation-error');
        const clearFormButton = document.getElementById('clear-form-button');
        const exportDataButton = document.getElementById('export-data-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmClearButton = document.getElementById('confirm-clear-button');
        const cancelClearButton = document.getElementById('cancel-clear-button');

        // --- Helper Functions ---
        const getCurrentModuleState = () => selectedModule ? (allModuleData[selectedModule] || (allModuleData[selectedModule] = { discoveryAnswers: {}, roiAnswers: {}, eskerSubscriptionCost: '', professionalServicesCost: '', numberOfYearsUtilized: '3', additionalDiscoveryNotes: [], calculatedRoi: null, scorecardAnswers: {}, calculatedScorecard: null, currentView: 'scorecard' })) : null;
        const showMessage = (el) => el.classList.remove('hidden');
        const hideMessage = (el) => el.classList.add('hidden');
        const showConfirmationModal = () => { confirmationModal.style.display = 'flex'; }
        const hideConfirmationModal = () => { confirmationModal.style.display = 'none'; }

        // --- Core Application Logic ---
        function populateStreamDropdown() {
            streamSelect.innerHTML = '<option value="">-- Choose Business Stream --</option>';
            for (const streamName in appModules) {
                const option = document.createElement('option');
                option.value = streamName;
                option.textContent = streamName;
                streamSelect.appendChild(option);
            }
        }

        function populateModuleDropdown(stream) {
            moduleSelect.innerHTML = '<option value="">-- Choose Module --</option>';
            if (stream && appModules[stream]) {
                for (const moduleName in appModules[stream]) {
                    const option = document.createElement('option');
                    option.value = moduleName;
                    option.textContent = moduleName;
                    moduleSelect.appendChild(option);
                }
            } else {
                 moduleSelect.innerHTML = '<option value="">-- Choose Stream First --</option>';
            }
        }

        function renderAppContent() {
            appContent.innerHTML = '';
            if (!selectedModule) {
                appContent.innerHTML = `<div class="text-center py-10 text-gray-500 text-xl">Please select a stream and module to begin.</div>`;
                return;
            }

            const state = getCurrentModuleState();
            const moduleData = appModules[selectedStream][selectedModule];
            currentView = state.currentView;

            // Render Tabs
            appContent.innerHTML = `<div class="flex justify-center mb-6">
                <button id="scorecard-tab" class="px-6 py-3 text-lg font-medium transition-all duration-300 ${currentView === 'scorecard' ? 'bg-ms-blue text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Scorecard</button>
                <button id="discovery-tab" class="px-6 py-3 text-lg font-medium transition-all duration-300 ${currentView === 'discovery' ? 'bg-ms-blue text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Discovery</button>
                <button id="roi-tab" class="px-6 py-3 text-lg font-medium transition-all duration-300 ${currentView === 'roi' ? 'bg-ms-blue text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">ROI</button>
            </div>`;

            const viewContainer = document.createElement('div');
            viewContainer.className = "bg-white p-6 rounded-xl shadow-inner";
            viewContainer.innerHTML = `<h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">${currentView.charAt(0).toUpperCase() + currentView.slice(1)}: ${selectedModule}</h2>`;

            if (currentView === 'scorecard') {
                viewContainer.innerHTML += scorecardQuestions.map((q, index) => `
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                        <label class="block text-md font-semibold text-gray-700 mb-2">${index + 1}. ${q.text}</label>
                        <div class="flex flex-wrap gap-x-6 gap-y-2">
                            ${scorecardAnswerOptions.map(option => `
                                <label class="inline-flex items-center"><input type="radio" name="${q.id}" value="${option}" class="form-radio h-5 w-5 text-ms-blue" ${state.scorecardAnswers[q.id] === option ? 'checked' : ''}> <span class="ml-2">${option}</span></label>
                            `).join('')}
                        </div>
                    </div>`).join('');
                viewContainer.innerHTML += `<div id="scorecard-results" class="mt-8 p-6 bg-blue-50 border-blue-200 rounded-lg shadow-md text-center"></div>`;
                appContent.appendChild(viewContainer);
                scorecardQuestions.forEach(q => document.getElementsByName(q.id).forEach(radio => radio.addEventListener('change', (e) => { state.scorecardAnswers[q.id] = e.target.value; calculateScorecard(); })));
                calculateScorecard();
            } else if (currentView === 'discovery') {
                viewContainer.innerHTML += moduleData.questions.map((q, index) => `
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                        <label for="${q.id}" class="block text-md font-semibold text-gray-700 mb-2">${index + 1}. ${q.text}</label>
                        ${q.type === 'textarea' ? `<textarea id="${q.id}" rows="4" class="w-full p-2 border rounded-md">${state.discoveryAnswers[q.id] || ''}</textarea>` : `<input id="${q.id}" type="${q.type}" value="${state.discoveryAnswers[q.id] || ''}" class="w-full p-2 border rounded-md">`}
                    </div>`).join('');
                 // Add Notes Section Here if desired
                 viewContainer.innerHTML += `<div class="flex justify-center mt-6"><button id="copy-to-roi-button" class="flex items-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg">Copy to ROI</button></div>`;
                appContent.appendChild(viewContainer);
                moduleData.questions.forEach(q => document.getElementById(q.id).addEventListener('input', e => state.discoveryAnswers[q.id] = e.target.value));
                document.getElementById('copy-to-roi-button').addEventListener('click', copyDiscoveryToRoi);
            } else if (currentView === 'roi') {
                viewContainer.innerHTML += `
                    <div class="mb-6 p-4 border-ms-blue-light rounded-lg bg-blue-50"><label class="block font-semibold">Annual Subscription Cost ($)</label><input id="annual-subscription-cost" type="number" value="${state.eskerSubscriptionCost}" class="w-full p-2 border rounded-md"></div>
                    <div class="mb-6 p-4 border-ms-blue-light rounded-lg bg-blue-50"><label class="block font-semibold">Professional Services Cost ($)</label><input id="professional-services-cost" type="number" value="${state.professionalServicesCost}" class="w-full p-2 border rounded-md"></div>
                    <div class="mb-6 p-4 border-ms-blue-light rounded-lg bg-blue-50"><label class="block font-semibold">Years Utilised</label><input id="number-of-years-utilized" type="number" value="${state.numberOfYearsUtilized}" class="w-full p-2 border rounded-md"></div>
                    ${moduleData.roiQuestions.map((q, index) => `<div class="mb-6 p-4 border rounded-lg bg-gray-50"><label for="${q.id}" class="block font-semibold">${index + 1}. ${q.text}</label><input id="${q.id}" type="number" value="${state.roiAnswers[q.id] || ''}" class="w-full p-2 border rounded-md"></div>`).join('')}
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="calculate-roi-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6">Calculate ROI</button>
                        <button id="populate-demo-data-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6">Demo Data</button>
                    </div>
                    <div id="roi-results" class="mt-8"></div>`;
                appContent.appendChild(viewContainer);
                document.getElementById('annual-subscription-cost').addEventListener('input', e => state.eskerSubscriptionCost = e.target.value);
                document.getElementById('professional-services-cost').addEventListener('input', e => state.professionalServicesCost = e.target.value);
                document.getElementById('number-of-years-utilized').addEventListener('input', e => state.numberOfYearsUtilized = e.target.value);
                moduleData.roiQuestions.forEach(q => document.getElementById(q.id).addEventListener('input', e => state.roiAnswers[q.id] = e.target.value));
                document.getElementById('calculate-roi-button').addEventListener('click', calculateRoi);
                document.getElementById('populate-demo-data-button').addEventListener('click', populateDemoData);
                if (state.calculatedRoi) renderRoiResults(state.calculatedRoi);
            }

            // Tab listeners
            document.getElementById('scorecard-tab').addEventListener('click', () => { state.currentView = 'scorecard'; renderAppContent(); });
            document.getElementById('discovery-tab').addEventListener('click', () => { state.currentView = 'discovery'; renderAppContent(); });
            document.getElementById('roi-tab').addEventListener('click', () => { state.currentView = 'roi'; renderAppContent(); });
        }

        function calculateScorecard() {
            const state = getCurrentModuleState();
            if (!state) return;
            let totalScore = 0;
            scorecardQuestions.forEach(q => { if (state.scorecardAnswers[q.id] === 'Yes') totalScore += scorecardYesPoints; });
            state.calculatedScorecard = totalScore;
            const resultsEl = document.getElementById('scorecard-results');
            if (resultsEl) {
                const maxScore = scorecardQuestions.length * scorecardYesPoints;
                resultsEl.innerHTML = `<h3 class="text-xl font-bold text-blue-700 mb-2">Opportunity Score</h3><p class="text-4xl font-bold text-purple-700">${totalScore} / ${maxScore}</p>`;
            }
        }

        function calculateRoi() {
            const state = getCurrentModuleState();
            if (!state) { showMessage(validationErrorMessage); return; }
            const moduleData = appModules[selectedStream][selectedModule];
            const annualSub = parseFloat(state.eskerSubscriptionCost);
            const profServices = parseFloat(state.professionalServicesCost);
            const years = parseInt(state.numberOfYearsUtilized);
            const roiInputs = {};
            let allValid = !isNaN(annualSub) && !isNaN(profServices) && !isNaN(years) && years > 0;
            moduleData.roiQuestions.forEach(q => {
                const val = parseFloat(state.roiAnswers[q.id]);
                if (isNaN(val)) allValid = false;
                roiInputs[q.id] = val;
            });
            if (!allValid) { showMessage(validationErrorMessage); return; }
            hideMessage(validationErrorMessage);

            let totalAnnualSavings = 0;
            let detailedBreakdown = {};
            moduleData.roiCalculationFormulas.forEach(f => {
                let inputs = {};
                let inputsValid = true;
                for (const key in f.inputs) {
                    const val = roiInputs[f.inputs[key]];
                    if(isNaN(val)) { inputsValid = false; break; }
                    inputs[key] = val;
                }
                if (inputsValid) {
                    const savings = f.formula(inputs, state);
                    totalAnnualSavings += savings;
                    detailedBreakdown[f.name] = `${f.description(inputs, state)} = $${savings.toFixed(2)}`;
                }
            });

            const totalInvestment = profServices + (annualSub * years);
            const totalBenefit = totalAnnualSavings * years;
            const netBenefit = totalBenefit - totalInvestment;
            const roiPercentage = totalInvestment > 0 ? (netBenefit / totalInvestment) * 100 : 0;
            const paybackMonths = totalAnnualSavings > annualSub ? (profServices / (totalAnnualSavings - annualSub)) * 12 : Infinity;
            
            state.calculatedRoi = { totalAnnualSavings: totalAnnualSavings.toFixed(2), totalInvestmentOverYears: totalInvestment.toFixed(2), totalBenefitOverYears: totalBenefit.toFixed(2), netBenefitOverYears: netBenefit.toFixed(2), roiPercentage: roiPercentage.toFixed(2), paybackPeriodMonths: isFinite(paybackMonths) ? paybackMonths.toFixed(1) : "N/A", detailedSavingsBreakdown: detailedBreakdown };
            renderRoiResults(state.calculatedRoi);
        }
        
        function renderRoiResults(roi) {
            const resultsEl = document.getElementById('roi-results');
            if (!resultsEl || !roi) return;
            resultsEl.innerHTML = `
                <div class="p-6 bg-blue-50 border-blue-200 rounded-lg">
                    <h3 class="text-xl font-bold text-center mb-4">ROI Summary</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <strong>Total Annual Savings:</strong> <span class="text-right text-green-700 font-bold">$${roi.totalAnnualSavings}</span>
                        <strong>Net Benefit (${getCurrentModuleState().numberOfYearsUtilized} Yrs):</strong> <span class="text-right text-blue-800 font-bold">$${roi.netBenefitOverYears}</span>
                        <strong>ROI Percentage:</strong> <span class="text-right text-purple-700 font-bold">${roi.roiPercentage}%</span>
                        <strong>Payback Period:</strong> <span class="text-right text-orange-700 font-bold">${roi.paybackPeriodMonths} Months</span>
                    </div>
                </div>`;
        }

        function copyDiscoveryToRoi() { /* Simplified, needs implementation based on new structure if required */ }
        function populateDemoData() {
            const state = getCurrentModuleState();
            const demoData = appModules[selectedStream][selectedModule].demoRoiData;
            if (state && demoData) {
                state.roiAnswers = { ...demoData };
                renderAppContent();
                calculateRoi();
            }
        }

        // --- Event Listeners & Initialization ---
        streamSelect.addEventListener('change', (e) => {
            selectedStream = e.target.value;
            selectedModule = ''; // Reset module selection
            moduleSelect.value = '';
            populateModuleDropdown(selectedStream);
            renderAppContent();
        });

        moduleSelect.addEventListener('change', (e) => {
            selectedModule = e.target.value;
            renderAppContent();
        });

        clearFormButton.addEventListener('click', showConfirmationModal);
        confirmClearButton.addEventListener('click', () => {
            if (selectedModule) delete allModuleData[selectedModule];
            renderAppContent();
            hideConfirmationModal();
        });
        cancelClearButton.addEventListener('click', hideConfirmationModal);
        closeValidationErrorButton.addEventListener('click', () => hideMessage(validationErrorMessage));
        exportDataButton.addEventListener('click', () => { /* Needs implementation for getReportData and formatters */ alert("Export function needs to be re-implemented."); });

        window.onload = () => {
            populateStreamDropdown();
            renderAppContent();
        };

    </script>
</body>
</html>
